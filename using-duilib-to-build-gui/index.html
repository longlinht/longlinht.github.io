<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Using Duilib to build GUI</title>
    <meta name="description" content="Dancing with Machine, Human and God - World is complex,confusing and wonderful,I will talk about machine,human and god to known it, to reveal it." />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    
    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Dancing with Machine, Human and God" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Dancing with Machine, Human and God" />
    <meta property="og:description" content="World is complex,confusing and wonderful,I will talk about machine,human and god to known it, to reveal it." />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Dancing with Machine, Human and God" />
    <meta name="twitter:description" content="World is complex,confusing and wonderful,I will talk about machine,human and god to known it, to reveal it." />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Tao's Page",
    "url": "/",
    "image": "/assets/images/cover1.jpg",
    "description": "World is complex,confusing and wonderful,I will talk about machine,human and god to known it, to reveal it."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Dancing with Machine, Human and God" href="/rss.xml" />

</head>
<body class="post-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about.html">About</a></li>
        <li class="nav-fables " role="presentation"><a href="/tag/machine/">Machine</a></li>
        <li class="nav-speeches " role="presentation"><a href="/tag/human/">Human</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/god/">God</a></li>
        <li class="nav-author " role="presentation"><a href="/author/hetao/">Author</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/rss.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-machine">

        <header class="post-header">
            <h1 class="post-title">Using Duilib to build GUI</h1>
            <section class="post-meta">
            <!-- <a href='/'>Tao He</a> -->
            <time class="post-date" datetime="2015-01-04">04 Jan 2015</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/tag/machine'>Machine</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <p>Duilib is a free open source DirectUI library on Windows , because its simple and expandable design and stable and efficient implementation, accepted generally by the major Internet companies  widely used in IM, video client, stock market software, navigation software, mobile phone support Software, security software and many PC client software in other industries. When We developed a IM in a company I worked, we even use this library to replace Qt GUI part we used in our code.</p>

<h4 id="basic-principle">Basic principle</h4>
<p>The native Windows user interface is composed of multiple WND, each WND has its own Handle and WndProc, while the DirectUI is directly drawn on the parent window (Paint on parent DC). That is, the child window is not created in the form of a window handle (windowless), but a logical window, using the GDI function to draw on the parent window. There is no extra WND, so the controls are all virtual, do not have their own message loop, they are using WND message loop. When the WND receives the message, it will locate the control and then passes the message to the specific control, which will response this message.</p>

<h3 id="class-architecture-of-library">Class architecture of library</h3>
<p><img src="http://wx2.sinaimg.cn/mw690/7033bf1dly1ffbgrdyw59j20zp0pw0zo.jpg" alt="" />
#### Basic library</p>

<h5 id="tool-library">Tool library</h5>

<p>DUILib is not depends on any other external library, so it implement basic tool library internally to support this project.</p>

<ul>
  <li>
    <p>UI related: CPoint, CSize, CDuiRect</p>
  </li>
  <li>
    <p>Simple Container: CStdPtrArray, CStdValArray, CStdString, CStdStringPtrMap</p>
  </li>
</ul>

<h5 id="control-library">Control library</h5>

<p>Control library has two parts to be implemented seperately in DUILib.</p>

<ul>
  <li>
    <p>Core - contains common parts all controls used and basic class.</p>
  </li>
  <li>
    <p>Control - contains all real(instantiaed) controls.</p>
  </li>
</ul>

<h3 id="message-process-mechanism">Message process mechanism</h3>

<h4 id="basic-process">Basic process</h4>

<p><img src="http://wx4.sinaimg.cn/mw690/7033bf1dly1ffbgrdt8bxj20ir0or75f.jpg" alt="" /></p>

<p>The DUILib framework’s basic message process similar to create window process in WIN32.</p>

<p>```c++
int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
{
    CPaintManagerUI::SetInstance(hInstance);        // 1, Instantiate handle and attach to render
    CPaintManagerUI::SetResourcePath(CPaintManagerUI::GetInstancePath() + _T(“skin”));
    HRESULT Hr = ::CoInitialize(NULL);              // 2,Initialize COM, and support to load COM
    if( FAILED(Hr) ) return 0;
    CMainFrameWnd* pFrame = new CMainFrameWnd();    // 3,Create window class
    if( pFrame == NULL ) return 0;
    pFrame-&gt;Create(NULL, _T(“Main”), UI_WNDSTYLE_FRAME, 0L, 0, 0, 800, 600); // 4, Register window class and create window instance.
    // Actually call Create to create a Win32 WND, do these operations internally:
    //  -&gt; RegisterSuperclass (Register a super class)
    //  -&gt; RegisterWindowClass （Register window class）
    //  -&gt; ::CreateWindowEx (Create window，trigger WM_CREATE)
    //  -&gt; HandleMessage  ( WM_CREATE process OnCreate)</p>

<pre><code>pFrame-&gt;CenterWindow();          // 5, Center window
::ShowWindow(*pFrame, SW_SHOW);
CPaintManagerUI::MessageLoop(); // 6, Process message loop
::CoUninitialize();            // 7, Exit program and release COM
return 0; } ```
</code></pre>

<ul>
  <li>Main message loop - CPaintManagerUI::MessageLoop, message will be first received by CPaintManagerUI’s TranslateMessage.</li>
</ul>

<p><code>c++
 void CPaintManagerUI::MessageLoop()
 {
     MSG msg = { 0 };
     while( ::GetMessage(&amp;msg, NULL, 0, 0) ) {    
         if( !CPaintManagerUI::TranslateMessage(&amp;msg) ) { 
             ::TranslateMessage(&amp;msg);
             ::DispatchMessage(&amp;msg); 
         }
     }
 }
</code>
* Create window - call CWindowWnd::Create to create window, and finish operations below:</p>

<pre><code>* If subclass system control(not DUILib control), set `__ControlProc` function as callback function.

* If not subclass, set `__WndProc` function as callback function.

* Use CreateWindowEx to create window instance.
</code></pre>

<ul>
  <li><code>__WndProc</code> </li>
</ul>

<p><code>c++
LRESULT CALLBACK CWindowWnd::__WndProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
    CWindowWnd* pThis = NULL;
    if( uMsg == WM_NCCREATE ) { // Bind class and window in this message
        LPCREATESTRUCT lpcs = reinterpret_cast&lt;LPCREATESTRUCT&gt;(lParam);   // From CreateWindowEx's last parameter( ptr to CWindowWnd )
        pThis = static_cast&lt;CWindowWnd*&gt;(lpcs-&gt;lpCreateParams);
        pThis-&gt;m_hWnd = hWnd;
        ::SetWindowLongPtr(hWnd, GWLP_USERDATA, reinterpret_cast&lt;LPARAM&gt;(pThis)); // Set to window's user data
    }
    else {
        pThis = reinterpret_cast&lt;CWindowWnd*&gt;(::GetWindowLongPtr(hWnd, GWLP_USERDATA));
        if( uMsg == WM_NCDESTROY &amp;&amp; pThis != NULL ) {
            LRESULT lRes = ::CallWindowProc(pThis-&gt;m_OldWndProc, hWnd, uMsg, wParam, lParam);    
            ::SetWindowLongPtr(pThis-&gt;m_hWnd, GWLP_USERDATA, 0L);    // Cancel class and window's bind relation
            if( pThis-&gt;m_bSubclassed ) pThis-&gt;Unsubclass();
            pThis-&gt;m_hWnd = NULL;
            pThis-&gt;OnFinalMessage(hWnd);
            return lRes;
        }
    }
    if( pThis != NULL ) {
        return pThis-&gt;HandleMessage(uMsg, wParam, lParam);  // Call subclass's messge process function
    }
    else {
        return ::DefWindowProc(hWnd, uMsg, wParam, lParam); 
    }
}
</code>
* Call CWindowWnd virtual function to subclass message.</p>

<ul>
  <li>
    <p>Event - DUILlib encapsulated message to be event and dispatch it to control.</p>
  </li>
  <li>
    <p>Notify - If want window to process some control’s message, call this function, let control notify window, while window will register itself in Notify receiver queue in its OnCreate.</p>
  </li>
</ul>

<h3 id="using-tips">Using tips</h3>
<ul>
  <li>
    <p>Inheriting the <code>WindowImplBase</code> class, then implement its unimplemented virtual metheds to satify specified situation;</p>
  </li>
  <li>
    <p><code>WindowImplBase</code> class already deal with some windows message by default,if some can’t satify specified situation,override it;</p>
  </li>
  <li>
    <p>If some windows messages have been not dealt with by WindowImplBase class, deal with in <code>HandleCustomMessage</code> method;</p>
  </li>
  <li>
    <p>To use <code>DUI_DECLARE_MESSAGE_MAP</code> macro  map message functon;</p>
  </li>
  <li>
    <p>Using <code>CDialogBuilder</code> to create custom control or container from xml file;</p>
  </li>
  <li>
    <p>Remember this point : Control and custom UI in xml file always a good choice in most of case;</p>
  </li>
  <li>
    <p>Organizing whole UI element in separated xml files and do not conflit with C++ class inheritance through CreateControl method;</p>
  </li>
</ul>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/hetao" style="background-image: url(/assets/images/casper.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/hetao">Tao He</a></h4>
                
                
                    <p> A computer engineer, reader and thinker.</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Beijing, China</span> 
                    <span class="author-link icon-link"><a href="http://longlinht.github.io/"> longlinht.github.io/</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Using Duilib to build GUI&amp;url=http://longlinht.github.io//using-duilib-to-build-gui"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://longlinht.github.io//using-duilib-to-build-gui"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://longlinht.github.io//using-duilib-to-build-gui"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hetaoof.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="http://longlinht.github.io//hello-world">
            <section class="post">
                <h2>Hello World</h2>
                <p>This is my first post for Machine category, I named it 'Hello World' to start...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="http://longlinht.github.io//c-sharp-create-unregular-window">
            <section class="post">
                <h2>C#创建不规则窗体(控件)</h2>
                <p><p>创建不规则窗体和控件这个过程包含了大量的图形编程工作，不同的计算机因内存和显卡的不同可能会导致最终的效果有所不同 。创建不规则窗体具体步骤：</p> <h4 id="section">先创建一个具有不规则形状的位图文件</h4> <ol> <li> <p>用任何画图程序创建不规则形状的位图。 </p> </li> <li> <p>用一种颜色画出一个不规则的区域作为程序的窗体，并用另一种颜色画出该位图的背景。</p> </li> </ol> <p>3．保存位图文件。</p> <h4...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Dancing with Machine, Human and God</a> &copy; 2017</section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-78960009-1', 'auto');
	    ga('send', 'pageview');

     </script>
   
</body>
</html>
