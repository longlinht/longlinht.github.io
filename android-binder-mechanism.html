<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Android Binder Mechanism</title>
    <meta name="description" content="与机器，人，神共舞 - 编程，读书，思考，旅行，与机器对话，与人交谈，对神发问，探索，体验人生美丽的风景" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    
    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="与机器，人，神共舞" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="与机器，人，神共舞" />
    <meta property="og:description" content="编程，读书，思考，旅行，与机器对话，与人交谈，对神发问，探索，体验人生美丽的风景" />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="与机器，人，神共舞" />
    <meta name="twitter:description" content="编程，读书，思考，旅行，与机器对话，与人交谈，对神发问，探索，体验人生美丽的风景" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Tao's Page",
    "url": "/",
    "image": "/assets/images/cover1.jpg",
    "description": "编程，读书，思考，旅行，与机器对话，与人交谈，对神发问，探索，体验人生美丽的风景"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="与机器，人，神共舞" href="/rss.xml" />

</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about.html">About</a></li>
        <li class="nav-fables " role="presentation"><a href="/tag/machine/">Machine</a></li>
        <li class="nav-speeches " role="presentation"><a href="/tag/human/">Human</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/god/">God</a></li>
        <li class="nav-author " role="presentation"><a href="/author/hetao/">Author</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/rss.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-machine">

        <header class="post-header">
            <h1 class="post-title">Android Binder Mechanism</h1>
            <section class="post-meta">
            <!-- <a href='/'>Tao He</a> -->

            
            <time class="post-date" datetime="2016-08-02">02 Aug 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/machine'>Machine</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <h4 id="what-is-binder">What is Binder</h4>

<ul>
  <li>The Binder mechanism has started from a simple idea.</li>
</ul>

<blockquote>
  <p>“Let requests and responses be written in an area where all processes can share and let each process refer to the memory address.”</p>
</blockquote>

<ul>
  <li>
    <p>Binder is a IPC mechanism.</p>
  </li>
  <li>
    <p>Binder implementation is based on <strong>OpenBinder</strong>.</p>
  </li>
  <li>
    <p>Binder refers to a kernel memory which is shared between all processes to minimize the overhead caused by memory copy.</p>
  </li>
  <li>
    <p>It provides the Remote Procedure Call (RPC) framework written in C++ for high productivity.</p>
  </li>
</ul>

<h4 id="why-need-binder">Why need Binder</h4>

<ul>
  <li>
    <p>Android need IPC mechanism because of its loosely coupled component design. Every application in Android is comprised of some components ,like Activity or Service, they maybe in same process or not. If they are in different process, they need communicate each other.</p>
  </li>
  <li>
    <p>All of the default system functions of Android are provided as the <strong>server process</strong> type. In other words, to use the functions such as <code class="language-plaintext highlighter-rouge">SurfaceFlinger</code> or <code class="language-plaintext highlighter-rouge">AudioFlinger</code>, a request should be made as a separate process that runs on the user mode. As all system services are provided as a <strong>server process</strong>, a mechanism to send requests and responses to other processes is necessary. In Android it is called the Binder. Android uses functions provided by other processes through Binder.</p>
  </li>
  <li>
    <p>Android is based on Linux, Linux has a lot of IPC mechanism. But, Android didn’t adopted it. Maybe because of performance and low memory of Android device.</p>
  </li>
</ul>

<h4 id="the-benefits-of-using-binder-mechanism">The Benefits of Using Binder Mechanism</h4>

<ul>
  <li>
    <p>Easy to expand or remove functions: It is easy to add a new system service or remove an existing function.</p>
  </li>
  <li>
    <p>Easy to port: Porting to a new processor requires few changes. A toolchain for porting is provided.</p>
  </li>
  <li>
    <p>Easy to test: Tests are limited by the component unit, so it is not necessary to test the entire services, and more strict tests are available.</p>
  </li>
  <li>
    <p>Support for distribution system: Process communication is based on the Binder, so it guarantees transparency in location between components.</p>
  </li>
</ul>

<h4 id="binder-driver">Binder Driver</h4>

<p>A Binder Driver is implemented to use the kernel space. The role of the Binder driver is to convert the memory address that each process has mapped with the memory address of the kernel space for reference.</p>

<h4 id="understanding-binder-mechanism-through-media-service">Understanding Binder Mechanism through Media Service</h4>

<h5 id="servicemanager"><code class="language-plaintext highlighter-rouge">ServiceManager</code></h5>

<p>ServiceManager is a system manager which manages all services in Android.</p>

<h5 id="what-is-media-service">What is Media Service</h5>

<ul>
  <li>
    <p>Media Service is a general C++ application, is core of android media.</p>
  </li>
  <li>
    <p>Media Service is a general service Android supplied.</p>
  </li>
  <li>
    <p>Source code location: <em>frameworks/base/media/mediaserver/main_mediaserver.cpp</em></p>
  </li>
  <li>
    <p>Entry point:</p>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Require a ServiceManager proxy</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span><span class="p">(</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">());</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">defaultServiceManager</span><span class="p">();</span>
    <span class="n">LOGI</span><span class="p">(</span><span class="s">"ServiceManager: %p"</span><span class="p">,</span> <span class="n">sm</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="n">AudioFlinger</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
    <span class="n">MediaPlayerService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
    <span class="n">CameraService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
    <span class="n">AudioPolicyService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
    
    <span class="c1">// Forever process messages sent from Binder.</span>
    <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
    <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joinThreadPool</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>
    <p>Media server service has four sub-module.</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">AudioFlinger</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">MediaPlayerService</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">CameraService</code></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">AudioPolicyService</code></p>
      </li>
    </ul>
  </li>
</ul>

<h5 id="processstate"><code class="language-plaintext highlighter-rouge">ProcessState</code></h5>

<ul>
  <li>
    <p>Source code location: <em>frameworks/base/libs/binder/ProcessState.cpp</em></p>
  </li>
  <li>
    <p>Media Service first call <code class="language-plaintext highlighter-rouge">ProcessState::self()</code></p>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gProcess</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">gProcess</span><span class="p">;</span>
    
    <span class="n">AutoMutex</span> <span class="n">_l</span><span class="p">(</span><span class="n">gProcessMutex</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gProcess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">gProcess</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessState</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">gProcess</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Then <code class="language-plaintext highlighter-rouge">ProcessState::self()</code> call ProcessState constructor</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ProcessState</span><span class="o">::</span><span class="n">ProcessState</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">mDriverFD</span><span class="p">(</span><span class="n">open_driver</span><span class="p">())</span>
    <span class="p">,</span> <span class="n">mVMStart</span><span class="p">(</span><span class="n">MAP_FAILED</span><span class="p">)</span> <span class="c1">// Map the memory start address</span>
    <span class="p">,</span> <span class="n">mManagesContexts</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mBinderContextCheckFunc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mBinderContextUserData</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mThreadPoolStarted</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mThreadPoolSeq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mDriverFD</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// XXX Ideally, there should be a specific define for whether we</span>
        <span class="c1">// have mmap (or whether we could possibly have the kernel module</span>
        <span class="c1">// availabla).</span>
<span class="cp">#if !defined(HAVE_WIN32_IPC)
</span>        <span class="c1">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
        <span class="n">mVMStart</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BINDER_VM_SIZE</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_NORESERVE</span><span class="p">,</span> <span class="n">mDriverFD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mVMStart</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// *sigh*</span>
            <span class="n">LOGE</span><span class="p">(</span><span class="s">"Using /dev/binder failed: unable to mmap transaction memory.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">close</span><span class="p">(</span><span class="n">mDriverFD</span><span class="p">);</span>
            <span class="n">mDriverFD</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#else
</span>        <span class="n">mDriverFD</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mDriverFD</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Need to run without the driver, starting our own thread pool.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">open_driver()</code> function</p>

    <ul>
      <li>
        <p>Very important function call to open a virtual device for communication.</p>
      </li>
      <li>
        <p>This functon will open this device <strong>/dev/binder</strong>.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>When <code class="language-plaintext highlighter-rouge">ProcessState::self()</code> complete, it had do two important jobs:</p>

    <ul>
      <li>Open the virtual device <strong>/dev/binder</strong>, so there has been a channel to communicate with kernel.</li>
      <li>Map <strong>/dev/binder</strong> device’s fd to memory.</li>
    </ul>
  </li>
</ul>

<h5 id="defaultservicemanager"><code class="language-plaintext highlighter-rouge">defaultServiceManager()</code></h5>

<ul>
  <li>
    <p>Source code location: <em>frameworks/base/libs/binder/IServiceManager.cpp</em></p>
  </li>
  <li>
    <p>Trace the source code call path, finally find that this call <code class="language-plaintext highlighter-rouge">sp&lt;IServiceManager&gt; sm = defaultServiceManager()</code> equals <code class="language-plaintext highlighter-rouge">gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code>.</p>
  </li>
  <li>
    <p>BpBinder</p>

    <ul>
      <li>
        <p>Source code location: <em>frameworks/base/libs/binder/BpBinder.cpp</em></p>
      </li>
      <li>
        <p>BpBinder constructor:</p>
      </li>
    </ul>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BpBinder</span><span class="o">::</span><span class="n">BpBinder</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">handle</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">mHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mAlive</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mObitsSent</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">mObituaries</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LOGV</span><span class="p">(</span><span class="s">"Creating BpBinder %p handle %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">mHandle</span><span class="p">);</span>

    <span class="n">extendObjectLifetime</span><span class="p">(</span><span class="n">OBJECT_LIFETIME_WEAK</span><span class="p">);</span>
    <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">incWeakHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>What did <code class="language-plaintext highlighter-rouge">interface_cast</code> do?</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">interface_cast</code> defined in <em>/home/tao/android_source/frameworks/base/include/binder/IInterface.h</em></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">interface_cast</code> defination</p>
      </li>
    </ul>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">INTERFACE</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">INTERFACE</span><span class="o">&gt;</span> <span class="n">interface_cast</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">INTERFACE</span><span class="o">::</span><span class="n">asInterface</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li>So <code class="language-plaintext highlighter-rouge">gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code> statement call <code class="language-plaintext highlighter-rouge">interface_cast</code> will equals:</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">inline</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">interface_cast</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">asInterface</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>We need find clue in <code class="language-plaintext highlighter-rouge">IServiceManager</code></p>

    <ul>
      <li>
        <p>Source code location: <em>frameworks/base/include/binder/IInterface.h</em></p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">IServiceManager</code> defination</p>
      </li>
    </ul>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IServiceManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IInterface</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">DECLARE_META_INTERFACE</span><span class="p">(</span><span class="n">ServiceManager</span><span class="p">);</span>

    <span class="cm">/**
     * Retrieve an existing service, blocking for a few seconds
     * if it doesn't yet exist.
     */</span>
    <span class="k">virtual</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span>         <span class="n">getService</span><span class="p">(</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/**
     * Retrieve an existing service, non-blocking.
     */</span>
    <span class="k">virtual</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span>         <span class="n">checkService</span><span class="p">(</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/**
     * Register a service.
     */</span>
    <span class="k">virtual</span> <span class="n">status_t</span>            <span class="n">addService</span><span class="p">(</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span>
                                            <span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">service</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/**
     * Return list of all existing services.
     */</span>
    <span class="k">virtual</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span>    <span class="n">listServices</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">enum</span> <span class="p">{</span>
        <span class="n">GET_SERVICE_TRANSACTION</span> <span class="o">=</span> <span class="n">IBinder</span><span class="o">::</span><span class="n">FIRST_CALL_TRANSACTION</span><span class="p">,</span>
        <span class="n">CHECK_SERVICE_TRANSACTION</span><span class="p">,</span>
        <span class="n">ADD_SERVICE_TRANSACTION</span><span class="p">,</span>
        <span class="n">LIST_SERVICES_TRANSACTION</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* We need trace this macro `DECLARE_META_INTERFACE(ServiceManager)` 
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DECLARE_META_INTERFACE(INTERFACE)                             
</span>    <span class="k">static</span> <span class="k">const</span> <span class="n">String16</span> <span class="n">descriptor</span><span class="p">;</span>                                 
    <span class="k">static</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">&gt;</span> <span class="n">asInterface</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">obj</span><span class="p">);</span>      
    <span class="k">virtual</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">getInterfaceDescriptor</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>           
    <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="p">();</span>                                                   
    <span class="k">virtual</span> <span class="o">~</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="p">();</span>                                          


<span class="cp">#define IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                     
</span>    <span class="k">const</span> <span class="n">String16</span> <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">descriptor</span><span class="p">(</span><span class="n">NAME</span><span class="p">);</span>                    
    <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">getInterfaceDescriptor</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>    
        <span class="k">return</span> <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">descriptor</span><span class="p">;</span>                              
    <span class="p">}</span>                                                                 
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">&gt;</span> <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">asInterface</span><span class="p">(</span><span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">obj</span><span class="p">)</span>
    <span class="p">{</span>                                                                 
        <span class="n">sp</span><span class="o">&lt;</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">&gt;</span> <span class="n">intr</span><span class="p">;</span>                                        
        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>                                            
            <span class="n">intr</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">*&gt;</span><span class="p">(</span>                        
                <span class="n">obj</span><span class="o">-&gt;</span><span class="n">queryLocalInterface</span><span class="p">(</span>                             
                        <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">descriptor</span><span class="p">).</span><span class="n">get</span><span class="p">());</span>             
            <span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>                                       
                <span class="n">intr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bp</span><span class="err">##</span><span class="n">INTERFACE</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>                        
            <span class="p">}</span>                                                         
        <span class="p">}</span>                                                             
        <span class="k">return</span> <span class="n">intr</span><span class="p">;</span>                                                  
    <span class="p">}</span>                                                                 
    <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>                                  
    <span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="o">::~</span><span class="n">I</span><span class="err">##</span><span class="n">INTERFACE</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>                                 
</code></pre></div></div>

<ul>
  <li>Finally, we find that <code class="language-plaintext highlighter-rouge">interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code> statement actually return a <code class="language-plaintext highlighter-rouge">BpServiceManager</code> object. It means <code class="language-plaintext highlighter-rouge">sp&lt;IServiceManager&gt; sm = defaultServiceManager()</code> acquired a <code class="language-plaintext highlighter-rouge">BpServiceManager</code> object.</li>
</ul>

<h5 id="bpservicemanager"><code class="language-plaintext highlighter-rouge">BpServiceManager</code></h5>

<ul>
  <li>Bp stands for Binder proxy, it means <code class="language-plaintext highlighter-rouge">BpServiceManager</code> is <code class="language-plaintext highlighter-rouge">ServiceManager</code>’s proxy to Binder.</li>
</ul>

<h5 id="mediaplayerservice"><code class="language-plaintext highlighter-rouge">MediaPlayerService</code></h5>

<ul>
  <li>
    <p>Source code location: <em>frameworks/base/media/libmediaplayerservice/MediaPlayerService.cpp</em></p>
  </li>
  <li>
    <p>Defination and instantiation</p>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">MediaPlayerService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">defaultServiceManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addService</span><span class="p">(</span>
            <span class="n">String16</span><span class="p">(</span><span class="s">"media.player"</span><span class="p">),</span> <span class="k">new</span> <span class="n">MediaPlayerService</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">MediaPlayerService</span><span class="o">::</span><span class="n">MediaPlayerService</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LOGV</span><span class="p">(</span><span class="s">"MediaPlayerService created"</span><span class="p">);</span>
    <span class="n">mNextConnId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MediaPlayerService</span><span class="o">::~</span><span class="n">MediaPlayerService</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LOGV</span><span class="p">(</span><span class="s">"MediaPlayerService destroyed"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">MediaPlayerService</code> derivatived from <code class="language-plaintext highlighter-rouge">BnMediaPlayerService</code></p>
  </li>
  <li>
    <p>Bn stands for Binder native.</p>
  </li>
  <li>
    <p>Add <code class="language-plaintext highlighter-rouge">MediaPlayerService</code> to <code class="language-plaintext highlighter-rouge">ServiceManager</code></p>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">virtual</span> <span class="n">status_t</span> <span class="nf">addService</span><span class="p">(</span><span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;&amp;</span> <span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Parcel</span> <span class="n">data</span><span class="p">,</span> <span class="n">reply</span><span class="p">;</span>
    <span class="n">data</span><span class="p">.</span><span class="n">writeInterfaceToken</span><span class="p">(</span><span class="n">IServiceManager</span><span class="o">::</span><span class="n">getInterfaceDescriptor</span><span class="p">());</span>
    <span class="n">data</span><span class="p">.</span><span class="n">writeString16</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">data</span><span class="p">.</span><span class="n">writeStrongBinder</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
    <span class="c1">// remote() return BpBinder object</span>
    <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">remote</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">transact</span><span class="p">(</span><span class="n">ADD_SERVICE_TRANSACTION</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">err</span> <span class="o">==</span> <span class="n">NO_ERROR</span> <span class="o">?</span> <span class="n">reply</span><span class="p">.</span><span class="n">readInt32</span><span class="p">()</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">remote()</code> return BpBinder</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">status_t</span> <span class="n">BpBinder</span><span class="o">::</span><span class="n">transact</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">code</span><span class="p">,</span> <span class="k">const</span> <span class="n">Parcel</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="n">Parcel</span><span class="o">*</span> <span class="n">reply</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Once a binder has died, it will never come back to life.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mAlive</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">transact</span><span class="p">(</span>
            <span class="n">mHandle</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">DEAD_OBJECT</span><span class="p">)</span> <span class="n">mAlive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">DEAD_OBJECT</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">IPCThreadState</code> do with transaction, write add service command and wait for response.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">BpServiceManager</code> had sent a add service message, but who receive and process it?</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">BnServiceManager</code>? unfortunately it doesn’t exist. service do same job.</p>
  </li>
  <li>
    <p>service</p>
    <ul>
      <li>
        <p>service is a general c++ applcation.</p>
      </li>
      <li>
        <p>Source code location: <em>frameworks/base/cmds/servicemanager/service_manager.c</em></p>
      </li>
      <li>
        <p>Entry point:</p>
      </li>
    </ul>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">binder_state</span> <span class="o">*</span><span class="n">bs</span><span class="p">;</span>
    <span class="c1">//  BINDER_SERVICE_MANAGER is NULL, is a magic number</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">svcmgr</span> <span class="o">=</span> <span class="n">BINDER_SERVICE_MANAGER</span><span class="p">;</span>

    <span class="n">bs</span> <span class="o">=</span> <span class="n">binder_open</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">binder_become_context_manager</span><span class="p">(</span><span class="n">bs</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">LOGE</span><span class="p">(</span><span class="s">"cannot become context manager (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">svcmgr_handle</span> <span class="o">=</span> <span class="n">svcmgr</span><span class="p">;</span>
    <span class="n">binder_loop</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">svcmgr_handler</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="conclusion">Conclusion</h4>

<p>Through tracing so many codes, the MediaPlayerService example maybe reveal the Binder’s mysterious veil. We need write down some important conclusions:</p>

<ul>
  <li>
    <p>If two processes need communicate each other, one as Client, the other is Server, Server need registered to <code class="language-plaintext highlighter-rouge">ServiceManager</code>, if Client want request to Server, it need query Server’s info from <code class="language-plaintext highlighter-rouge">ServiceManager</code>, based the qureid info, Client and Server can communicate each other.</p>
  </li>
  <li>
    <p>Client, Server, <code class="language-plaintext highlighter-rouge">ServiceManager</code> are implemented in use space, Binder is implemented in kernel space.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ServiceManager</code> and Binder is implemented by Android, developers need implemente their Client and Server.</p>
  </li>
  <li>
    <p>Binder supplied device file <strong>/dev/binder</strong> communicate to user space. Client, Server and <code class="language-plaintext highlighter-rouge">ServiceManager</code> communicated to Binder through <code class="language-plaintext highlighter-rouge">open</code> and <code class="language-plaintext highlighter-rouge">ioctl</code> file operation function.</p>
  </li>
  <li>
    <p>Client and Server communicate each other immediately through Binder.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ServiceManager</code> is a daemon process, it manages Server, supply interface to qurey Server function.</p>
  </li>
</ul>

<p>If want to learn Android IPC mechanism deeply, a lot of Android source code need be read. Linus said:</p>

<blockquote>
  <p>Read The Fucking Source Code.</p>
</blockquote>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="/java-garbage-collection">
            <section class="post">
                <h2>Understanding Java Garbage Collection</h2>
                <p>**stop-the-world** Stop-the-world means that the JVM is stopping the application from running to execute a...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/memory-leak-in-android-development">
            <section class="post">
                <h2>Memory Leak in Android Development</h2>
                <p>When programming Android, although java has GC mechanism, some our wrong code way and personal...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">与机器，人，神共舞</a> &copy; 2023</section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-78960009-1', 'auto');
	    ga('send', 'pageview');

     </script>
   
</body>
</html>
